### 方案文档（ReadMe）

#### 1. 对 .canvas 文件的理解

- •

  **结构分析**：`.canvas`文件是包含对话流程的 JSON 格式数据，由 `nodes`（对话节点）和 `edges`（节点关系）组成：

  - •

    `nodes`：每个节点包含 `id`、`type`、`text`（用户与 AI 的对话内容）、坐标和尺寸信息

  - •

    `edges`：描述节点间连接关系（`fromNode`→ `toNode`）

- •

  **数据类型**：多轮心理辅导对话数据，包含用户情绪表达、AI 的认知行为疗法（CBT）回应

- •

  **应用场景**：用于训练心理支持助手模型，学习如何引导用户缓解焦虑、识别自动负面念头、建立行为干预策略

#### 2. 数据预处理方案

**目标**：清洗无效数据、统一格式、处理对话分支、适配阿里云百炼平台输入要求

| 步骤        | 目标         | 方法                                                         |
| :---------- | :----------- | :----------------------------------------------------------- |
| 1. 数据清洗 | 移除无效节点 | 过滤 `text`为空或非对话型节点（如系统节点）                  |
| 2. 分支处理 | 处理对话分叉 | 识别分叉点（如节点 `4008e23866bf76c8`），将分支转换为独立对话链 |
| 3. 文本解析 | 拆分角色内容 | 用正则提取 `用户：`和 `AI：`的对话内容                       |
| 4. 序列构建 | 生成连续对话 | 沿 `edges`连接关系构建时间线，处理多轮对话的连续性           |
| 5. 格式转换 | 适配百炼格式 | 转换为 `{"messages": [{role, content}...]}`结构              |
| 6. 数据增强 | 提升泛化能力 | 生成同义句式（如将"我太烂了"→"我能力不足"）                  |

#### 3. 数据格式转换流程

```
graph TD
    A[原始.canvas文件] 
    → B[分支识别：主路径+分支路径]
    → C[文本解析：拆分为user/assistant]
    → D[构建连续对话链]
    → E[转换为SFT-ChatML格式]
    → F[输出.jsonl文件]
```

#### 4. 造数据逻辑

**核心原则**：保持心理辅导的专业性，覆盖关键对话模式：

1. 

   **认知重构**：生成"事件-信念-结果"案例

   *例：用户："考试时手抖" → AI："这是身体焦虑信号，不是能力问题"*

2. 

   **行为实验**：设计渐进式挑战任务

   *例：{"role":"assistant","content":"今天先尝试在图书馆停留10分钟如何？"}*

3. 

   **自动念头识别**：创建负面思维变体

   *例：用户输入："我肯定失败" → 扩展为"我毫无价值"/"我永远做不好"*

4. 

   **共情回应**：生成情感确认句式

   *例："听起来这让你感到孤立无援"*

5. 

   **跨场景泛化**：移植对话模式到新场景

   *例：将"考试焦虑"转为"工作汇报焦虑"*

### 项目结构

```
canvas-converter/
├── api.py             # FastAPI 服务
├── app.py             # Streamlit UI 应用
├── requirements.txt  # 依赖包
└── example.canvas     # 示例数据文件
```

### 依赖文件 (requirements.txt)

```
fastapi>=0.85.0
uvicorn>=0.19.0
python-multipart>=0.0.5
requests>=2.28.1
streamlit>=1.22.0
```

### 使用说明

1. 

   **安装依赖**：

   ```
   pip install -r requirements.txt
   ```

2. 

   **启动 FastAPI 服务**：

   ```
   python api.py
   ```

   API 服务将在 `http://localhost:8000`运行

3. 

   **启动 Streamlit UI**：

   ```
   streamlit run app.py
   ```

   UI 应用将在 `http://localhost:8501`运行